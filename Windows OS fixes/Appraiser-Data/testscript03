# Extended Script: Refresh Appraiser Data, Validate Intune Enrollment, Trigger Sync, Auto-Remediate
$TaskName = "\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser"
$LogFile = "C:\Temp\Appraiser_Intune_Remediation.log"

# Ensure log directory exists
if (!(Test-Path "C:\Temp")) { New-Item -ItemType Directory -Path "C:\Temp" }

Add-Content $LogFile "`n[$(Get-Date)] Starting Appraiser and Intune checks..."

# --- Check Appraiser Task ---
$task = Get-ScheduledTask -TaskName "Microsoft Compatibility Appraiser" -TaskPath "\Microsoft\Windows\Application Experience\" -ErrorAction SilentlyContinue
if ($task) {
    $info = Get-ScheduledTaskInfo -TaskName "Microsoft Compatibility Appraiser" -TaskPath "\Microsoft\Windows\Application Experience\"
    Add-Content $LogFile "Appraiser Task Found. LastRun: $($info.LastRunTime), Status: $($info.LastTaskResult)"
    
    if (([datetime]::Now - $info.LastRunTime).Days -gt 7 -or $info.LastTaskResult -ne 0) {
        Add-Content $LogFile "Triggering Appraiser refresh..."
        schtasks /run /tn $TaskName | Out-Null
        Add-Content $LogFile "Appraiser task triggered."
    } else {
        Add-Content $LogFile "Appraiser data is up-to-date."
    }
} else {
    Add-Content $LogFile "Appraiser task missing. Attempting system repair..."
    sfc /scannow
    DISM /Online /Cleanup-Image /RestoreHealth
}

# --- Validate Intune Enrollment ---
Add-Content $LogFile "`nChecking Intune Enrollment Status..."
$dsreg = dsregcmd /status
$aadJoined = ($dsreg | Select-String "AzureAdJoined").ToString()
$enterpriseJoined = ($dsreg | Select-String "EnterpriseJoined").ToString()
$mdmUrl = ($dsreg | Select-String "MdmUrl").ToString()
$prtStatus = ($dsreg | Select-String "AzureAdPrt").ToString()

Add-Content $LogFile "AAD Join: $aadJoined"
Add-Content $LogFile "Enterprise Join: $enterpriseJoined"
Add-Content $LogFile "MDM URL: $mdmUrl"
Add-Content $LogFile "PRT Status: $prtStatus"

# --- Remediation if Enrollment Broken ---
if ($aadJoined -notmatch "YES" -or $enterpriseJoined -notmatch "YES" -or $mdmUrl -notmatch "manage.microsoft.com") {
    Add-Content $LogFile "Enrollment appears broken. Attempting remediation..."
    try {
        dsregcmd /leave
        Restart-Computer -Force
        # After reboot, rejoin
        dsregcmd /join
        Add-Content $LogFile "Remediation attempted: Device left and rejoined Azure AD."
    } catch {
        Add-Content $LogFile "Remediation failed: $_"
    }
} else {
    Add-Content $LogFile "Device is properly enrolled in Intune."
}

# --- Trigger Intune Sync ---
Add-Content $LogFile "`nTriggering Intune Sync..."
Invoke-Expression "Start-Process -FilePath 'IntuneManagementExtension.exe' -ArgumentList '-sync' -NoNewWindow"
Add-Content $LogFile "Intune sync initiated."

Write-Host "Process complete. Log saved to $LogFile"
``
